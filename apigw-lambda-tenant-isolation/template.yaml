AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Lambda Tenant Isolation Demo
  
  Demonstration project showcasing AWS Lambda's tenant isolation feature
  with two Lambda functions - one with tenant isolation enabled and one without.

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 30
    MemorySize: 128
    Runtime: python3.14

Parameters:
  Environment:
    Type: String
    Default: dev
    Description: Environment name for resource naming
    AllowedValues:
      - dev
      - staging
      - prod

Resources:
  # IAM Execution Role for Lambda Functions
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-lambda-execution-role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CloudWatchLogsPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*"

  # Standard Lambda Function (without tenant isolation)
  CounterStandardFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-counter-standard"
      CodeUri: src/standard/
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Description: Lambda function without tenant isolation for counter demonstration
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /standard
            Method: get

  # CloudWatch Log Group for Standard Function
  CounterStandardLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-counter-standard"
      RetentionInDays: 14

  # Tenant-Isolated Lambda Function (with tenant isolation enabled)
  CounterIsolatedFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-counter-isolated"
      CodeUri: src/isolated/
      Handler: lambda_function.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Description: Lambda function with tenant isolation enabled for counter demonstration
      TenancyConfig:
        TenantIsolationMode: PER_TENANT
      Environment:
        Variables:
          LOG_LEVEL: INFO

  # CloudWatch Log Group for Isolated Function
  CounterIsolatedLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-counter-isolated"
      RetentionInDays: 14

  # API Gateway REST API
  ApiGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub "${AWS::StackName}-api"
      Description: API Gateway for Lambda tenant isolation demonstration
      EndpointConfiguration:
        Types:
          - REGIONAL
      SecurityPolicy: SecurityPolicy_TLS13_1_3_2025_09
      EndpointAccessMode: BASIC

  # Request Validator for API Gateway
  RequestValidator:
    Type: AWS::ApiGateway::RequestValidator
    Properties:
      RestApiId: !Ref ApiGateway
      Name: !Sub "${AWS::StackName}-request-validator"
      ValidateRequestParameters: true
      ValidateRequestBody: false

  # Error Model for API Gateway responses
  ErrorModel:
    Type: AWS::ApiGateway::Model
    Properties:
      RestApiId: !Ref ApiGateway
      Name: ErrorModel
      ContentType: application/json
      Schema:
        $schema: http://json-schema.org/draft-04/schema#
        title: Error Schema
        type: object
        properties:
          error:
            type: string
          message:
            type: string
          statusCode:
            type: integer

  # Standard endpoint resource
  StandardResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref ApiGateway
      ParentId: !GetAtt ApiGateway.RootResourceId
      PathPart: standard

  # Standard endpoint method (with optional header mapping for demonstration)
  StandardMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGateway
      ResourceId: !Ref StandardResource
      HttpMethod: GET
      AuthorizationType: NONE
      RequestParameters:
        method.request.header.x-tenant-id: false  # Optional parameter
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CounterStandardFunction.Arn}/invocations"
        RequestParameters:
          integration.request.header.X-Amz-Tenant-Id: method.request.header.x-tenant-id
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: Empty
        - StatusCode: 405
          ResponseModels:
            application/json: !Ref ErrorModel
        - StatusCode: 500
          ResponseModels:
            application/json: !Ref ErrorModel

  # OPTIONS method for Standard endpoint (CORS support)
  StandardOptionsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGateway
      ResourceId: !Ref StandardResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  # Isolated endpoint resource
  IsolatedResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref ApiGateway
      ParentId: !GetAtt ApiGateway.RootResourceId
      PathPart: isolated

  # Isolated endpoint method with header mapping
  IsolatedMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGateway
      ResourceId: !Ref IsolatedResource
      HttpMethod: GET
      AuthorizationType: NONE
      RequestParameters:
        method.request.header.x-tenant-id: true  # Required parameter
      RequestValidatorId: !Ref RequestValidator
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CounterIsolatedFunction.Arn}/invocations"
        RequestParameters:
          integration.request.header.X-Amz-Tenant-Id: method.request.header.x-tenant-id
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: Empty
        - StatusCode: 400
          ResponseModels:
            application/json: !Ref ErrorModel
        - StatusCode: 405
          ResponseModels:
            application/json: !Ref ErrorModel
        - StatusCode: 500
          ResponseModels:
            application/json: !Ref ErrorModel

  # OPTIONS method for Isolated endpoint (CORS support)
  IsolatedOptionsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref ApiGateway
      ResourceId: !Ref IsolatedResource
      HttpMethod: OPTIONS
      AuthorizationType: NONE
      Integration:
        Type: MOCK
        IntegrationResponses:
          - StatusCode: 200
            ResponseParameters:
              method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,x-tenant-id'"
              method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
              method.response.header.Access-Control-Allow-Origin: "'*'"
            ResponseTemplates:
              application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{"statusCode": 200}'
      MethodResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: false
            method.response.header.Access-Control-Allow-Methods: false
            method.response.header.Access-Control-Allow-Origin: false

  # Lambda permissions for API Gateway to invoke functions
  StandardFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CounterStandardFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/*"

  IsolatedFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CounterIsolatedFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ApiGateway}/*/*"

  # API Gateway Deployment
  ApiGatewayDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - StandardMethod
      - StandardOptionsMethod
      - IsolatedMethod
      - IsolatedOptionsMethod
    Properties:
      RestApiId: !Ref ApiGateway

  # API Gateway Stage
  ApiGatewayStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId: !Ref ApiGateway
      DeploymentId: !Ref ApiGatewayDeployment
      StageName: !Ref Environment
      Description: !Sub "Stage for ${Environment} environment"

Outputs:
  # API Gateway endpoint URLs  
  StandardMultiTenantAPIEndpointUrl:
    Description: "URL for the standard Lambda function endpoint"
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${ApiGatewayStage}/standard"
    Export:
      Name: !Sub "${AWS::StackName}-standard-url"
  
  IsolatedTenantAPIEndpointUrl:
    Description: "URL for the tenant-isolated Lambda function endpoint"
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${ApiGatewayStage}/isolated"
    Export:
      Name: !Sub "${AWS::StackName}-isolated-url"
