AWSTemplateFormatVersion: 2010-09-09
Transform: 'AWS::Serverless-2016-10-31'
Description: An Amazon REST API gateway integrated with a AWS Lambda function that calls AWS Translate service to translate given text into specified language.

# Global values that are applied to all applicable resources in this template
Globals:
  Function:
    CodeUri: ./src
    Runtime: python3.9
    MemorySize: 128
    Timeout: 15

Resources:
  # Lambda Function - uses Globals to define additional configuration values
  LambdaFunction:
    Type: 'AWS::Serverless::Function'
    Properties:
      FunctionName: apigw-translate
      Handler: index.lambda_handler
      Policies:
      - TranslateReadOnly

  # API Gateway REST API
  RestApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: apigw-lambda-translate
      Description: An Amazon API Gateway REST API and AWS Lambda function.
      EndpointConfiguration:
        Types:
          - REGIONAL

  # POST method for the REST API
  RestApiMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      AuthorizationType: NONE
      HttpMethod: POST
      MethodResponses:
        - ResponseModels:
            application/json : 'Empty'
          StatusCode: 200
      Integration:
        IntegrationHttpMethod: POST
        Type: AWS_PROXY
        Uri: !Sub
          - 'arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations'
          - lambdaArn: !GetAtt LambdaFunction.Arn
      ResourceId: !GetAtt RestApi.RootResourceId
      RestApiId: !Ref RestApi

  # REST API Deployment
  RestApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn: RestApiMethod
    Properties:
      Description: Lambda Rest API Deployment
      RestApiId: !Ref RestApi

  # Stage for REST API Deployment
  RestApiStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      DeploymentId: !Ref RestApiDeployment
      Description: Lambda API Stage
      RestApiId: !Ref RestApi
      StageName: prod

  # Function permissions grant an AWS service
  FunctionResourcePermission:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      Principal: apigateway.amazonaws.com
      FunctionName: !Ref LambdaFunction
      SourceArn: !Sub 'arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${RestApi}/*'

Outputs:
  RestApiEndpoint:
    Description: The endpoint for the REST API Gateway.
    Value: !Sub "https://${RestApi}.execute-api.${AWS::Region}.amazonaws.com/prod/"
