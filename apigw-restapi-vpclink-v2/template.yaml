Transform: AWS::Serverless-2016-10-31
Description: REST API Gatewayus using VPC Link V2 integration with a Load Balancer
Parameters:
  LoadBalancerArn:
    Description: The ARN of the private ALB or NLB used with the VPC Link
    Type: String
  LoadBalancerDnsName:
    Description: the integration URI (DNS Name of the LoadBalancer for HTTP port 80 requests - or the DNS Name of the Certificate used on the SSL Listener port 443)
    Type: String 
  VpcId:
    Description: ID of an existing Virtual Private Cloud (VPC).
    Type: AWS::EC2::VPC::Id
  PrivateSubnetIds:
    Description: Select at least 2 existing private subnets which are also used on the Load Balancer
    Type: List<AWS::EC2::Subnet::Id>

Resources:
  SecurityGroupAlbVpcLink:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: VPC Link V2 security group
      SecurityGroupEgress:
        - Description: Allow all outbound traffic
          IpProtocol: '-1'
          CidrIp: 0.0.0.0/0
      VpcId: !Ref VpcId

  VpcLinkV2:
    Type: AWS::ApiGatewayV2::VpcLink
    DependsOn: SecurityGroupAlbVpcLink
    Properties:
      Name: VpcLinkAlbRest
      SecurityGroupIds: 
      - !Ref SecurityGroupAlbVpcLink
      SubnetIds: !Ref PrivateSubnetIds

  RestAPIAlb:
    Type: AWS::Serverless::Api
    DependsOn: VpcLinkV2
    Properties:
      Name: !Sub
        - ${ResourceName} From Stack ${AWS::StackName}
        - ResourceName: RestAPIAlb
      EndpointConfiguration: REGIONAL
      StageName: slay
      DefinitionBody:
        openapi: '3.0'
        paths:
          /vpclink-v2:
            get:
              x-amazon-apigateway-integration:
                connectionType: VPC_LINK
                connectionId: !Ref VpcLinkV2
                httpMethod: ANY
                type: http_proxy
                uri: !Ref LoadBalancerDnsName
                integrationTarget: !Ref LoadBalancerArn
              responses:
                "200":
                  description: "200 response"
          /mock:
            get:
              responses:
                "200":
                  description: "200 response"
              x-amazon-apigateway-integration:
                type: "mock"
                responses:
                  default:
                    statusCode: "200"
                    responseTemplates:
                      application/json: "{\n\"body\" : \"success!! Don't stoFP believing!!\",\n }"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"

Outputs:
  ApiEndpoint:
    Description: API Gateway Endpoint URL
    Value: !Sub 'https://${RestAPIAlb}.execute-api.${AWS::Region}.amazonaws.com/Stage/vpclink-v2'
    Export:
      Name: !Sub '${AWS::StackName}-ApiEndpoint'