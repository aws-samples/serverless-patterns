<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>

<body>
    <!-- Nav bar -->
    <nav class="navbar bg-secondary-subtle">
        <div class="container-fluid">
            <a class="navbar-brand">
                <i class="bi bi-clipboard"></i>&nbsp;Flashcards
            </a>
        </div>
    </nav>
    <nav class="navbar bg-secondary-subtle">
        <div class="container-fluid">
            <div class="d-flex justify-content-center w-100">
                <form class="d-flex" role="search">
                    <select id="categorySelect" class="form-select border-secondary me-2 form-control-sm"
                        aria-label="Select category">
                        <option selected>Select category</option>
                    </select>
                    <div class="input-group input-group-sm me-2">
                        <input id="maxItemsInput" class="form-control border-secondary" value="10" disabled />
                        <button id="incrementButton" class="btn btn-outline-secondary"><i
                                class="bi bi-plus-lg"></i></button>
                        <button id="decrementButton" class="btn btn-outline-secondary"><i
                                class="bi bi-dash-lg"></i></button>
                    </div>
                    <button id="generateButton" class="btn btn-outline-secondary btn-sm" type="submit"><i
                            class="bi bi-file-earmark-plus"></i></button>
                </form>
            </div>
        </div>
    </nav>

    <!-- Error container -->
    <div id="errorContainer">

    </div>

    <!-- Content container -->
    <div id="contentContainer" class="container mt-3">
        <div class="p-3 bg-info-subtle border border-info border-5 border-end-0 border-top-0 border-bottom-0">
            To create a flashcards test select a category, adjust the number of questions and press the generate
            <code>(<i class="bi bi-file-earmark-plus"></i>)</code> button.<br>
            <strong>Enjoy!</strong>
        </div>
    </div>

    <!-- Progress container -->
    <div id="progressContainer">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
    <script src="./flashcards.js"></script>

    <script defer>
        const apiClient = new ApiClient();
        const progressHelper = new ProgressHelper();
        const errorHandler = new ErrorHandler();
        const categorySelect = document.getElementById('categorySelect');
        const numberInput = document.getElementById('maxItemsInput');
        const incrementButton = document.getElementById('incrementButton');
        const decrementButton = document.getElementById('decrementButton');
        const generateButton = document.getElementById('generateButton');
        incrementButton.addEventListener('click', (event) => {
            event.preventDefault();
            updateValue(true);
        });
        decrementButton.addEventListener('click', (event) => {
            event.preventDefault();
            updateValue(false);
        });
        generateButton.addEventListener('click', async (event) => {
            event.preventDefault();
            generate();
        });
        function updateValue(increment) {
            let currentValue = parseInt(numberInput.value) || 0;
            if (increment && currentValue < 20) {
                currentValue += 1;
            } else if (!increment && currentValue > 1) {
                currentValue -= 1;
            }
            numberInput.value = currentValue;
        }
        function createAnswerOptions(item, flashcardId) {
            const allAnswers = [item.correctAnswer, ...item.incorrectAnswers];
            return allAnswers.map(answer => {
                const answerId = 'answer' + crypto.randomUUID();
                return `
                    <div>
                        <input type="radio" id="${answerId}" name="${flashcardId}" value="${answer}">
                        <label for="${answerId}"><strong>${answer}</strong></label>
                    </div>`;
            }).join('');
        }
        async function refreshPage() {
            errorHandler.hideErrors();
            progressHelper.showProgress();
            try {
                const response = await apiClient.fetchCategories();
                response.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.Id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                progressHelper.hideProgress();
                numberInput.value = 10;
            } catch (error) {
                progressHelper.hideProgress();
                errorHandler.showError(error.message || 'Unknown error');
            }
        }
        function createFlashcards(flashcards) {
            const container = document.getElementById('contentContainer');
            container.innerHTML = '';
            for (let flashcardsGroupIndex = 0; flashcardsGroupIndex < flashcards.length; flashcardsGroupIndex += 3) {
                const flashcardsGroup = flashcards.slice(flashcardsGroupIndex, flashcardsGroupIndex + 3);
                const cardGroup = document.createElement('div');
                cardGroup.className = 'row card-group';
                flashcardsGroup.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = 'col-md-4 mb-4';
                    card.innerHTML = `
                        <div class="card h-100 bg-secondary-subtle">
                            <div class="card-body">
                                <h5 class="card-title">Question ${flashcardsGroupIndex + index + 1}</h5>
                                <p class="card-text">${item.question}</p>
                                <div>
                                    ${createAnswerOptions(item, flashcardsGroupIndex + index)}
                                </div>
                            </div>
                            <div class="card-footer bg-transparent bg-secondary-subtle text-center">
                                <button class="btn btn-primary" id="verifyBtn${flashcardsGroupIndex + index}" disabled>Verify Answer</button>
                            </div>
                        </div>`;
                    const verifyButton = card.querySelector(`#verifyBtn${flashcardsGroupIndex + index}`);
                    verifyButton.disabled = true;
                    verifyButton.style.cursor = 'default';
                    verifyButton.style.borderColor = 'transparent';
                    verifyButton.addEventListener('click', () => {
                        card.querySelectorAll('input').forEach(radio => {
                            let label = document.querySelector(`label[for="${radio.id}"]`);
                            if (radio.value === item.correctAnswer) {
                                label.className = 'text-success';
                            } else {
                                if (radio.checked) {
                                    label.className = 'text-danger text-decoration-line-through';
                                } else {
                                    label.className = 'text-danger';
                                }
                            }
                        });
                        const selectedAnswer = card.querySelector('input:checked');
                        if (selectedAnswer && selectedAnswer.value === item.correctAnswer) {
                            card.querySelector('.card').className = 'card border-success bg-success-subtle h-100 ';
                            card.querySelector('.card-footer').className = 'card-footer border-success bg-transparent text-center';
                            verifyButton.className = 'btn bg-success-subtle opacity-100';
                            verifyButton.innerHTML = '<strong class="text-success">Correct!</strong>'
                        } else {
                            card.querySelector('.card').className = 'card border-danger bg-danger-subtle h-100';
                            card.querySelector('.card-footer').className = 'card-footer border-danger bg-transparent text-center';
                            verifyButton.className = 'btn bg-danger-subtle opacity-100';
                            verifyButton.innerHTML = '<strong class="text-danger">Incorrect!</strong>'
                        }
                        card.querySelectorAll('input').forEach(radio => {
                            radio.disabled = true;
                        });
                    });
                    card.querySelectorAll('input').forEach(radio => {
                        radio.addEventListener('change', () => {
                            if (verifyButton && verifyButton.disabled) {
                                verifyButton.disabled = false;
                            }
                        });
                    });
                    cardGroup.appendChild(card);
                });
                container.appendChild(cardGroup);
            }
        }
        async function generate() {
            errorHandler.hideErrors();
            progressHelper.showProgress();
            try {
                const categoryId = Number(document.getElementById('categorySelect').value);
                const maxItems = Number(document.getElementById('maxItemsInput').value);
                const response = await apiClient.fetchFlashcards(categoryId, maxItems);
                createFlashcards(response.flashcards);
                progressHelper.hideProgress();
            } catch (error) {
                progressHelper.hideProgress();
                errorHandler.showError(error.message || 'Unknown error');
            }
        }
        document.addEventListener('DOMContentLoaded', async () => {
            refreshPage();
        });
    </script>
</body>

</html>