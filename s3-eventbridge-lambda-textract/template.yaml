AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'SAM template for an S3 object upload to invoke a Lambda function through EventBridge that detects the text in a document through Amazon Textract'

Resources:
  # Input S3 bucket
  InputBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-input-bucket-${AWS::AccountId}'
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true

  # Output S3 bucket  
  OutputBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${AWS::StackName}-output-bucket-${AWS::AccountId}'

  # Lambda function
  TextractFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-textract-function'
      Handler: index.handler
      Runtime: python3.8
      CodeUri: src/
      Timeout: 30
      Environment:
        Variables:
          OUTPUT_BUCKET: !Ref OutputBucket
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref InputBucket
        - S3WritePolicy:
            BucketName: !Ref OutputBucket
        - Statement:
            - Effect: Allow
              Action: 
                - textract:DetectDocumentText
              Resource: '*'
 

  # EventBridge Rule
  S3ObjectCreatedRule:
    Type: AWS::Events::Rule
    Properties:
      Description: "Rule to capture S3 object created events"
      EventPattern:
        source:
          - aws.s3
        detail-type:
          - Object Created
        detail:
          bucket:
            name:
              - !Ref InputBucket
      State: "ENABLED"
      Targets: 
        - Arn: !GetAtt TextractFunction.Arn
          Id: "TextractFunctionTarget"

  # Permission for EventBridge to invoke Lambda
  TextractFunctionPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref TextractFunction
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: !GetAtt S3ObjectCreatedRule.Arn

Outputs:
  InputBucketName:
    Description: 'Name of the input S3 bucket'
    Value: !Ref InputBucket
  OutputBucketName:
    Description: 'Name of the output S3 bucket'
    Value: !Ref OutputBucket
  TextractFunctionName:
    Description: 'Name of the Textract Lambda function'
    Value: !Ref TextractFunction
  TextractFunctionArn:
    Description: 'ARN of the Textract Lambda function'
    Value: !GetAtt TextractFunction.Arn
